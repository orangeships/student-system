# 第二阶段：数据库设计与后端核心开发

## 1. 数据库设计与建模

### 数据模型分析
- **用户模型(User)**：用户基本信息、预算设置
- **交易记录模型(Transaction)**：收支记录核心数据
- **分类模型(Category)**：收支类别预设数据
- **预算模型(Budget)**：用户预算规划数据

### 数据库表结构设计
**用户表(users_user)**
- 基础字段：ID、用户名、邮箱、密码哈希
- 业务字段：月度预算、注册时间、最后登录时间
- 扩展字段：头像、个人简介

**交易记录表(finance_transaction)**
- 基础字段：ID、创建时间、更新时间
- 业务字段：金额、类型(收入/支出)、分类、日期、备注
- 关联字段：用户ID（外键）

**分类表(finance_category)**
- 基础字段：ID、名称、类型
- 业务字段：图标、颜色、排序权重
- 系统字段：是否系统预设

**预算表(finance_budget)**
- 基础字段：ID、用户ID、月份
- 业务字段：预算金额、实际支出、预算类别

### 数据库关系设计
- 用户 ↔ 交易记录：一对多关系
- 用户 ↔ 预算：一对多关系  
- 分类 ↔ 交易记录：一对多关系
- 建立适当的数据库索引优化查询性能

## 2. Django应用架构设计

### 应用模块划分
```
backend/
├── users/                    # 用户管理应用
│   ├── models.py           # 用户数据模型
│   ├── views.py            # 用户相关视图
│   ├── serializers.py      # 用户序列化器
│   └── urls.py             # 用户路由
├── finance/                 # 财务核心应用
│   ├── models.py           # 交易、分类模型
│   ├── views.py            # 财务业务视图
│   ├── serializers.py      # 财务数据序列化
│   ├── services.py         # 业务逻辑服务层
│   └── urls.py             # 财务路由
└── common/                  # 通用功能应用
    ├── utils.py            # 工具函数
    ├── constants.py        # 常量定义
    └── permissions.py      # 权限类
```

### 数据模型实现方法
- 使用Django ORM定义模型类
- 设置字段类型、约束条件和默认值
- 定义模型方法和属性
- 配置模型元数据（排序、权限等）

## 3. API接口设计与实现

### RESTful API架构设计
**认证相关API**
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录  
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/user` - 获取当前用户信息

**用户管理API**
- `PUT /api/users/profile` - 更新用户信息
- `PUT /api/users/budget` - 设置月度预算

**交易记录API**
- `GET /api/transactions/` - 获取交易列表（支持分页和过滤）
- `POST /api/transactions/` - 创建交易记录
- `GET /api/transactions/{id}/` - 获取单条交易详情
- `PUT /api/transactions/{id}/` - 更新交易记录
- `DELETE /api/transactions/{id}/` - 删除交易记录

**统计分析API**
- `GET /api/statistics/monthly` - 月度统计概览
- `GET /api/statistics/categories` - 分类统计
- `GET /api/statistics/trend` - 收支趋势分析

**数据规划API**
- `GET /api/planning/prediction` - 财务预测
- `POST /api/planning/budgets` - 设置分类预算

### 序列化器设计
- 用户序列化器：处理用户注册、登录、信息更新
- 交易记录序列化器：处理交易数据的输入输出
- 统计序列化器：格式化统计结果数据
- 嵌套序列化器：处理关联数据的序列化

## 4. 业务逻辑层实现

### 用户认证系统
- 配置Django认证后端
- 实现JWT令牌认证
- 设置权限控制（登录要求、对象级权限）
- 密码加密和安全策略

### 交易记录业务逻辑
**创建交易流程**
1. 数据验证（金额、分类、日期）
2. 关联用户信息
3. 数据持久化
4. 更新相关统计缓存

**查询优化策略**
- 数据库查询优化（select_related、prefetch_related）
- 分页处理
- 过滤器实现（按时间、分类、类型）
- 排序支持

### 统计计算服务
**月度统计计算**
```python
# 伪代码逻辑
def calculate_monthly_stats(user, year, month):
    # 查询当月所有交易记录
    # 计算总收入、总支出、结余
    # 按分类统计支出分布
    # 计算预算执行进度
    # 返回结构化统计数据
```

**分类统计实现**
- 按预设分类聚合交易数据
- 计算各分类占比
- 生成图表所需数据格式

### 数据规划功能实现
**财务预测模型**
- 基于历史数据的简单趋势分析
- 考虑季节性因素（学期开始/结束）
- 固定支出识别和预测
- 收入稳定性评估

**预算监控机制**
- 实时计算预算执行进度
- 预算超支预警逻辑
- 预算调整建议生成

## 5. 服务层与工具函数

### 业务服务封装
- **TransactionService**：交易记录核心业务
- **StatisticsService**：统计计算服务
- **PlanningService**：数据规划服务
- **UserService**：用户相关业务

### 通用工具函数
- 日期处理工具
- 金额格式化
- 数据验证工具
- 缓存管理工具

## 6. 权限与安全配置

### 权限控制系统
- 全局权限设置（DEFAULT_PERMISSION_CLASSES）
- 视图级权限控制
- 对象级权限验证
- 自定义权限类

### 安全配置
- 密码策略配置
- 会话管理
- CSRF保护
- 数据输入验证
- SQL注入防护

## 7. 测试数据与开发工具

### 测试数据生成
- 创建开发用测试用户
- 生成模拟交易数据
- 预设分类数据初始化
- 数据库种子数据脚本

### 开发辅助工具
- Django Admin后台配置
- API文档自动生成（Swagger/DRF Spectacular）
- 数据库管理工具
- 日志配置和调试工具

## 8. 数据库迁移与部署准备

### 数据库迁移策略
- 生成初始迁移文件
- 测试迁移过程
- 准备回滚方案
- 生产环境迁移脚本

### 性能优化准备
- 数据库索引优化
- 查询性能分析
- 缓存策略设计
- 静态文件配置

## 实现功能清单

### 核心功能完成标准
- ✅ 用户注册登录系统正常工作
- ✅ 交易记录CRUD操作完整
- ✅ 基础统计计算准确
- ✅ API接口测试通过
- ✅ 权限控制生效
- ✅ 数据验证完善

### 验收测试要点
1. 用户能成功注册和登录
2. 能创建、查询、更新、删除交易记录
3. 统计数据显示正确
4. 权限控制阻止未授权访问
5. 数据验证防止非法输入

这个阶段完成后，您将拥有一个功能完整的后端API服务，为前端开发提供坚实的数据支持和业务逻辑基础。预计需要2-3周时间完成。